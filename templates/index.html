<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisky Label Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .input-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .output-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .output-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .whisky-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
        }

        .whisky-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .whisky-info p {
            margin-bottom: 5px;
            color: #495057;
        }

        .label-preview {
            max-width: 100%;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .whisky-image {
            text-align: center;
            margin: 20px 0;
        }

        .bottle-image {
            max-width: 200px;
            max-height: 300px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .examples {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .examples h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .examples ul {
            list-style: none;
            padding: 0;
        }

        .examples li {
            padding: 5px 0;
            color: #424242;
        }

        .examples li:before {
            content: "ðŸ¥ƒ ";
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header, .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¥ƒ Whisky Label Generator</h1>
            <p>Generate beautiful labels with QR codes for your whisky collection</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <h2>Generate Label</h2>
                <form id="labelForm">
                    <div class="form-group">
                        <label for="whiskyId">Whisky ID (from Whiskybase):</label>
                        <input type="number" id="whiskyId" name="whisky_id" placeholder="e.g., 12345">
                    </div>
                    <div class="form-group">
                        <label for="whiskyName">Whisky Name (optional):</label>
                        <input type="text" id="whiskyName" name="whisky_name" placeholder="e.g., Macallan 18 Year Old">
                    </div>
                    <div class="form-group">
                        <label for="distillery">Distillery (optional):</label>
                        <input type="text" id="distillery" name="distillery" placeholder="e.g., The Macallan">
                    </div>
                    <div class="form-group">
                        <label for="abv">ABV (optional):</label>
                        <input type="text" id="abv" name="abv" placeholder="e.g., 43%">
                    </div>
                    <div class="form-group">
                        <label for="age">Age (optional):</label>
                        <input type="text" id="age" name="age" placeholder="e.g., 18 years">
                    </div>
                    
                    <div class="form-group">
                        <label for="width_mm">Label Width (mm):</label>
                        <input type="number" id="width_mm" name="width_mm" value="35" min="10" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="height_mm">Label Height (mm):</label>
                        <input type="number" id="height_mm" name="height_mm" value="37" min="10" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="dpi">Resolution (DPI):</label>
                        <select id="dpi" name="dpi">
                            <option value="72">72 DPI (Screen)</option>
                            <option value="150">150 DPI (Medium Print)</option>
                            <option value="300">300 DPI (High Quality Print)</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn" id="generateBtn" style="flex: 1;">Generate Label</button>
                        <button type="button" class="btn" id="clearBtn" style="flex: 1; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="clearLabelForm()">Clear Form</button>
                    </div>
                </form>
                
                <div class="examples">
                    <h3>Quick Examples (Real Whiskybase IDs):</h3>
                    <ul>
                        <li onclick="fillExample('balvenie_12')">Balvenie 12 Year Old (ID: 1)</li>
                        <li onclick="fillExample('talisker_25')">Talisker 25 Year Old (ID: 123)</li>
                        <li onclick="fillExample('balvenie_14')">Balvenie 14 Year Old Roasted Malt (ID: 2)</li>
                        <li onclick="fillExample('lagavulin_30')">Lagavulin 30 Year Old (ID: 10)</li>
                        <li onclick="fillExample('bruichladdich_20')">Bruichladdich Blacker Still (ID: 100)</li>
                        <li onclick="fillExample('inchgower_27')">Inchgower 1976 (ID: 500)</li>
                    </ul>
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e9ecef;">
                
                <h2>Batch Label Generation</h2>
                <form id="batchForm">
                    <div class="form-group">
                        <label for="batchIds">Whisky IDs (comma-separated):</label>
                        <textarea id="batchIds" name="batch_ids" rows="4" placeholder="e.g., 1, 123, 2, 10, 100, 500" style="resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="batchWidth">Label Width (mm):</label>
                        <input type="number" id="batchWidth" name="batch_width" value="35" min="10" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="batchHeight">Label Height (mm):</label>
                        <input type="number" id="batchHeight" name="batch_height" value="37" min="10" max="100" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="batchDpi">Resolution (DPI):</label>
                        <select id="batchDpi" name="batch_dpi">
                            <option value="72">72 DPI (Screen)</option>
                            <option value="150">150 DPI (Medium Print)</option>
                            <option value="300">300 DPI (High Quality Print)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn" id="batchBtn">Generate Batch Labels</button>
                </form>
                
                <div class="examples">
                    <h3>Batch Examples:</h3>
                    <ul>
                        <li onclick="fillBatchExample('popular')">Popular Whiskies (IDs: 1, 123, 2, 10)</li>
                        <li onclick="fillBatchExample('premium')">Premium Collection (IDs: 100, 500, 1000, 1500)</li>
                        <li onclick="fillBatchExample('clear')">Clear All</li>
                    </ul>
                </div>
            </div>
            
            <div class="output-section">
                <h2>Generated Label</h2>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Fetching whisky data and generating label...</p>
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="whiskyInfo" class="whisky-info" style="display: none;"></div>
                <div id="whiskyImage" class="whisky-image" style="display: none;">
                    <img id="whiskyBottle" class="bottle-image" alt="Whisky Bottle">
                </div>
                <img id="labelPreview" class="label-preview" style="display: none;">
            </div>
        </div>
    </div>

    <script>
        document.getElementById('labelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const whiskyId = document.getElementById('whiskyId').value;
            const whiskyName = document.getElementById('whiskyName').value;
            const distillery = document.getElementById('distillery').value;
            const abv = document.getElementById('abv').value;
            const age = document.getElementById('age').value;
            const widthMm = document.getElementById('width_mm').value;
            const heightMm = document.getElementById('height_mm').value;
            const dpi = document.getElementById('dpi').value;
            
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const whiskyInfo = document.getElementById('whiskyInfo');
            const whiskyImage = document.getElementById('whiskyImage');
            const whiskyBottle = document.getElementById('whiskyBottle');
            const labelPreview = document.getElementById('labelPreview');
            
            // Reset UI
            error.style.display = 'none';
            whiskyInfo.style.display = 'none';
            whiskyImage.style.display = 'none';
            labelPreview.style.display = 'none';
            loading.style.display = 'block';
            generateBtn.disabled = true;
            
            try {
                let whiskyData;
                
                // If manual data is provided, use it
                if (whiskyName || distillery || abv || age) {
                    whiskyData = {
                        id: whiskyId || Math.floor(Math.random() * 100000),
                        name: whiskyName || `Whisky #${whiskyId || 'Custom'}`,
                        distillery: distillery || 'Custom Distillery',
                        abv: abv || 'Unknown ABV',
                        age: age || '',
                        url: whiskyId ? `https://www.whiskybase.com/whisky/${whiskyId}` : '#'
                    };
                } else if (whiskyId) {
                    // Try to fetch from Whiskybase
                    const infoResponse = await fetch(`/api/whisky/${whiskyId}`);
                    whiskyData = await infoResponse.json();
                    
                    if (whiskyData.error) {
                        throw new Error(`Failed to fetch whisky data: ${whiskyData.error}`);
                    }
                } else {
                    throw new Error('Please provide either a Whisky ID or manual whisky details.');
                }
                
                // Populate form fields with fetched data
                if (whiskyData.name) document.getElementById('whiskyName').value = whiskyData.name;
                if (whiskyData.distillery) document.getElementById('distillery').value = whiskyData.distillery;
                if (whiskyData.abv) document.getElementById('abv').value = whiskyData.abv;
                if (whiskyData.age) document.getElementById('age').value = whiskyData.age;
                
                // Display whisky information
                whiskyInfo.innerHTML = `
                    <h3>${whiskyData.name}</h3>
                    <p><strong>Distillery:</strong> ${whiskyData.distillery}</p>
                    <p><strong>ABV:</strong> ${whiskyData.abv}</p>
                    ${whiskyData.age ? `<p><strong>Age:</strong> ${whiskyData.age}</p>` : ''}
                    <p><strong>ID:</strong> ${whiskyData.id}</p>
                `;
                whiskyInfo.style.display = 'block';
                
                // Display whisky image if available
                if (whiskyData.image_url) {
                    whiskyBottle.src = whiskyData.image_url;
                    whiskyBottle.onload = function() {
                        whiskyImage.style.display = 'block';
                    };
                    whiskyBottle.onerror = function() {
                        // Hide image if it fails to load
                        whiskyImage.style.display = 'none';
                    };
                }
                
                // Generate and display label
                let labelUrl;
                if (whiskyName || distillery || abv || age) {
                    // Use custom label endpoint with manual data
                    const params = new URLSearchParams({
                        name: whiskyName || `Whisky #${whiskyId || 'Custom'}`,
                        distillery: distillery || 'Custom Distillery',
                        abv: abv || 'Unknown ABV',
                        age: age || '',
                        id: whiskyId || 'Custom',
                        width_mm: widthMm,
                        height_mm: heightMm,
                        dpi: dpi,
                        t: Date.now()
                    });
                    labelUrl = `/api/custom-label?${params}`;
                } else {
                    // Use automatic label endpoint
                    labelUrl = `/api/label/${whiskyId}?width_mm=${widthMm}&height_mm=${heightMm}&dpi=${dpi}&t=${Date.now()}`;
                }
                labelPreview.src = labelUrl;
                labelPreview.onload = function() {
                    labelPreview.style.display = 'block';
                    loading.style.display = 'none';
                    generateBtn.disabled = false;
                    
                                         // Automatically download the label using fetch and blob
                     fetch(labelUrl)
                         .then(response => response.blob())
                         .then(blob => {
                             const a = document.createElement('a');
                             const url = window.URL.createObjectURL(blob);
                             a.href = url;
                             // Create a simple filename
                             const filename = `whisky_label_${whiskyData.id}_${Date.now()}.png`;
                             console.log('Downloading file:', filename);
                             a.download = filename;
                             document.body.appendChild(a);
                             a.click();
                             window.URL.revokeObjectURL(url);
                             document.body.removeChild(a);
                         })
                         .catch(err => {
                             console.error('Download failed:', err);
                         });
                };
                
            } catch (err) {
                error.textContent = err.message || 'An error occurred while generating the label.';
                error.style.display = 'block';
                loading.style.display = 'none';
                generateBtn.disabled = false;
            }
        });
        
        // Function to fill example data with real Whiskybase IDs
        // Function to clear the label form
        function clearLabelForm() {
            document.getElementById('whiskyId').value = '';
            document.getElementById('whiskyName').value = '';
            document.getElementById('distillery').value = '';
            document.getElementById('abv').value = '';
            document.getElementById('age').value = '';
            document.getElementById('width_mm').value = '35';
            document.getElementById('height_mm').value = '37';
            document.getElementById('dpi').value = '72';
        }
        
        function fillExample(type) {
            const examples = {
                balvenie_12: { id: 1 },
                talisker_25: { id: 123 },
                balvenie_14: { id: 2 },
                lagavulin_30: { id: 10 },
                bruichladdich_20: { id: 100 },
                inchgower_27: { id: 500 }
            };
            
            const example = examples[type];
            if (example) {
                // Clear manual input fields
                document.getElementById('whiskyName').value = '';
                document.getElementById('distillery').value = '';
                document.getElementById('abv').value = '';
                document.getElementById('age').value = '';
                
                // Set the whisky ID to fetch real data from Whiskybase
                document.getElementById('whiskyId').value = example.id;
            }
        }
        
        // Function to fill batch example data
        function fillBatchExample(type) {
            const batchExamples = {
                popular: '1, 123, 2, 10',
                premium: '100, 500, 1000, 1500',
                clear: ''
            };
            
            const example = batchExamples[type];
            if (example !== undefined) {
                document.getElementById('batchIds').value = example;
            }
        }
        
        // Batch form submission
        document.getElementById('batchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const batchIds = document.getElementById('batchIds').value;
            const batchWidth = document.getElementById('batchWidth').value;
            const batchHeight = document.getElementById('batchHeight').value;
            const batchDpi = document.getElementById('batchDpi').value;
            const batchBtn = document.getElementById('batchBtn');
            
            if (!batchIds.trim()) {
                alert('Please enter at least one whisky ID.');
                return;
            }
            
            // Parse IDs (remove spaces, split by comma)
            const whiskyIds = batchIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            if (whiskyIds.length === 0) {
                alert('Please enter valid whisky IDs.');
                return;
            }
            
            batchBtn.disabled = true;
            batchBtn.textContent = 'Generating...';
            
            try {
                const response = await fetch('/api/batch-labels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        whisky_ids: whiskyIds,
                        width_mm: parseInt(batchWidth),
                        height_mm: parseInt(batchHeight),
                        dpi: parseInt(batchDpi)
                    })
                });
                
                if (response.ok) {
                    // Create a download link for the ZIP file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `batch_labels_${Date.now()}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert(`Successfully generated ${whiskyIds.length} labels! Download started.`);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate batch labels');
                }
                
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                batchBtn.disabled = false;
                batchBtn.textContent = 'Generate Batch Labels';
            }
        });
    </script>
</body>
</html>
